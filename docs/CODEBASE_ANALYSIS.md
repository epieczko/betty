# Betty Framework - Comprehensive Codebase Analysis

## Executive Summary

The Betty Framework is an **AI-native SDLC system** built on Anthropic's Claude Code Plugins platform. It implements a **five-layer architecture** that transforms Claude Code's plugin system into a structured, auditable engineering discipline for API-driven development.

**Status**: Phase 3 (Commands/User Interface) currently implemented; Phase 4 (Agents) in progress

---

## Project Organization & Directory Structure

```
/home/user/betty/
â”œâ”€â”€ betty/                           # Core Python utilities (shared)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                   # Configuration, paths, constants, enums
â”‚   â”œâ”€â”€ errors.py                   # Exception classes for error handling
â”‚   â”œâ”€â”€ validation.py               # Input validation functions
â”‚   â”œâ”€â”€ file_utils.py              # File I/O utilities
â”‚   â””â”€â”€ logging_utils.py            # Logging setup
â”‚
â”œâ”€â”€ skills/                          # Skills (Execution Layer)
â”‚   â”œâ”€â”€ agent.define/              # Layer 2: Validate/register agents (ACTIVE)
â”‚   â”œâ”€â”€ api.compatibility/          # Detect breaking changes (ACTIVE)
â”‚   â”œâ”€â”€ api.define/                # Create OpenAPI specs (ACTIVE)
â”‚   â”œâ”€â”€ api.generate-models/       # Generate models via Modelina (ACTIVE)
â”‚   â”œâ”€â”€ api.validate/              # Validate specs (ACTIVE)
â”‚   â”œâ”€â”€ hook.define/               # Register hooks (ACTIVE)
â”‚   â”œâ”€â”€ registry.update/           # Update skill registry (ACTIVE)
â”‚   â”œâ”€â”€ skill.create/              # Scaffold new skills (ACTIVE)
â”‚   â”œâ”€â”€ skill.define/              # Validate/register skills (ACTIVE)
â”‚   â”œâ”€â”€ workflow.compose/          # Execute workflows (ACTIVE)
â”‚   â””â”€â”€ workflow.validate/         # Validate workflow YAML (ACTIVE)
â”‚
â”œâ”€â”€ agents/                          # Agents (Reasoning Layer - Phase 4)
â”‚   â”œâ”€â”€ api.designer/              # Design APIs [draft]
â”‚   â””â”€â”€ api.analyzer/              # Analyze API compatibility [draft]
â”‚
â”œâ”€â”€ .claude/                         # Claude Code Plugin Configuration
â”‚   â”œâ”€â”€ commands/                  # Slash commands (Phase 3)
â”‚   â”‚   â”œâ”€â”€ README.md             # Command documentation
â”‚   â”‚   â”œâ”€â”€ api-design.md         # /api-design command
â”‚   â”‚   â”œâ”€â”€ api-validate.md       # /api-validate command
â”‚   â”‚   â”œâ”€â”€ api-generate.md       # /api-generate command
â”‚   â”‚   â””â”€â”€ api-compatibility.md  # /api-compatibility command
â”‚   â””â”€â”€ hooks.yaml                 # Hook definitions (generated by hook.define)
â”‚
â”œâ”€â”€ workflows/                       # Workflow definitions (Orchestration Layer)
â”‚   â””â”€â”€ [example workflows]
â”‚
â”œâ”€â”€ registry/                        # Registries (databases)
â”‚   â”œâ”€â”€ skills.json               # Skill registry (11 active skills)
â”‚   â”œâ”€â”€ agents.json               # Agent registry (2 draft agents)
â”‚   â””â”€â”€ workflow_history.json     # Workflow execution audit trail
â”‚
â”œâ”€â”€ docs/                           # Documentation
â”‚   â”œâ”€â”€ betty-architecture.md      # Five-layer architecture spec
â”‚   â”œâ”€â”€ betty-framework-overview.md
â”‚   â”œâ”€â”€ api-driven-development.md # Complete API-first guide
â”‚   â”œâ”€â”€ agent-define-implementation-plan.md
â”‚   â”œâ”€â”€ agent-schema-reference.md
â”‚   â””â”€â”€ references.md
â”‚
â”œâ”€â”€ src/                            # Generated models (output)
â”‚   â””â”€â”€ models/user-service/*.ts   # TypeScript models example
â”‚
â”œâ”€â”€ tests/                          # Test suite
â”œâ”€â”€ specs/                          # API specifications
â””â”€â”€ README.md                       # Project overview
```

---

## The Five-Layer Architecture

### Layer 1: Commands (User Interface) - PHASE 3 COMPLETE

**Purpose**: Provide intuitive slash commands for users

**Status**: IMPLEMENTED
- âœ… `/api-design <service-name>` - Design API from scratch
- âœ… `/api-validate <spec-path>` - Validate specifications  
- âœ… `/api-generate <spec-path> <language>` - Generate models
- âœ… `/api-compatibility <old> <new>` - Check breaking changes

**Location**: `/home/user/betty/.claude/commands/`

**What's Missing**: **command.define skill** (planned in api-driven-development.md line 97-99)
- No skill exists yet to programmatically create/register new commands
- Commands are currently manually defined in markdown files
- Need infrastructure to support command registration via skill

---

### Layer 2: Agents (Reasoning Layer) - PHASE 4 IN PROGRESS

**Purpose**: Provide intelligent, iterative orchestration with feedback loops

**Status**: PARTIALLY IMPLEMENTED
- âœ… `agent.define` skill (validates & registers agents) - ACTIVE
- âœ… `api.designer` agent (draft) - defined in `/registry/agents.json`
- âœ… `api.analyzer` agent (draft) - defined in `/registry/agents.json`
- âœ… Agent manifest schema defined in `betty-architecture.md`
- âœ… Agent registry infrastructure: `/registry/agents.json`

**Implementation**: `/home/user/betty/skills/agent.define/agent_define.py`
- Full implementation with validation logic
- Validates: name format, version (semver), reasoning_mode, skill references, capabilities
- Creates/updates `/registry/agents.json`

**Schema Fields**:
- Required: `name`, `version`, `description`, `capabilities`, `skills_available`, `reasoning_mode`
- Optional: `status`, `context_requirements`, `workflow_pattern`, `example_task`, `error_handling`, `output`, `tags`, `dependencies`

**Agent Configuration in betty/config.py**:
```python
REQUIRED_AGENT_FIELDS = ["name", "version", "description", "capabilities", "skills_available", "reasoning_mode"]

class AgentStatus(Enum):
    DRAFT = "draft"
    ACTIVE = "active"
    DEPRECATED = "deprecated"
    ARCHIVED = "archived"

class ReasoningMode(Enum):
    ITERATIVE = "iterative"      # Can retry with feedback
    ONESHOT = "oneshot"          # Executes once without retry
```

---

### Layer 3: Workflows (Orchestration Layer) - STABLE

**Purpose**: Define repeatable, auditable multi-step processes

**Status**: FULLY IMPLEMENTED
- âœ… `workflow.compose` skill - Executes YAML workflows
- âœ… `workflow.validate` skill - Validates workflow structure
- âœ… Workflow execution audit trail in `/registry/workflow_history.json`

**Location**: `/home/user/betty/skills/workflow.compose/`

**Features**:
- Sequential execution of skills
- Conditional execution (when clauses)
- Output variable passing
- Audit trail logging
- Error handling and cleanup

---

### Layer 4: Skills (Execution Layer) - STABLE  

**Purpose**: Provide atomic, testable, reusable operations

**Status**: FULLY IMPLEMENTED - 11 Active Skills

| Skill | Purpose | Status |
|-------|---------|--------|
| `skill.create` | Scaffold new skill directories | ACTIVE |
| `skill.define` | Validate & register skills | ACTIVE |
| `registry.update` | Update skill registry | ACTIVE |
| `workflow.compose` | Execute workflows | ACTIVE |
| `workflow.validate` | Validate workflow YAML | ACTIVE |
| `api.define` | Create OpenAPI/AsyncAPI specs | ACTIVE |
| `api.validate` | Validate specs against guidelines | ACTIVE |
| `api.generate-models` | Generate models via Modelina | ACTIVE |
| `api.compatibility` | Detect breaking changes | ACTIVE |
| `hook.define` | Register validation hooks | ACTIVE |
| `agent.define` | Validate & register agents | ACTIVE |

**Skill Manifest Structure** (in `skill.yaml`):
- Required: `name`, `version`, `description`, `inputs`, `outputs`, `status`
- Optional: `dependencies`, `entrypoints`, `permissions`, `tags`

**Validation** (in `betty/validation.py`):
- Skill names must match: `^[a-z][a-z0-9._-]*$`
- Versions must follow semantic versioning

---

### Layer 5: Hooks (Validation/Policy Layer) - STABLE

**Purpose**: Automatic validation and policy enforcement

**Status**: FULLY IMPLEMENTED

**Location**: `/home/user/betty/.claude/hooks.yaml`

**Implemented Hook Configuration** (from real file):
```yaml
hooks:
  on_file_edit:
    - name: python betty-skills-api-validate-api_validate-py {file_path} zalando-all.openapi.yaml
      command: python betty/skills/api.validate/api_validate.py {file_path} zalando
      blocking: true
      timeout: 10000
      when:
        pattern: '*.openapi.yaml'
      description: Validate OpenAPI specs against Zalando guidelines on every edit
    
    - name: python betty-skills-api-validate-api_validate-py {file_path}-all.asyncapi.yaml
      command: python betty/skills/api.validate/api_validate.py {file_path}
      blocking: true
      timeout: 10000
      when:
        pattern: '*.asyncapi.yaml'
      description: Validate AsyncAPI specs on every edit
```

**Supported Events**:
- `on_file_edit` - File edited in editor
- `on_file_save` - File saved
- `on_commit` - Git commit attempted
- `on_push` - Git push attempted
- `on_tool_use` - Tool used
- `on_agent_start` - Agent execution begins
- `on_workflow_end` - Workflow completes

**Hook Features**:
- Pattern matching for file selection
- Blocking vs non-blocking execution
- Timeout configuration
- Error handling strategy

**Implementation**: `/home/user/betty/skills/hook.define/hook_define.py`
- Creates hook configurations
- Updates `.claude/hooks.yaml`
- Manages hook registry

---

## Core Infrastructure Components

### Configuration System (`betty/config.py`)

**Key Configuration**:
```python
BETTY_HOME = os.environ.get('BETTY_HOME', ...)
BASE_DIR = BETTY_HOME
SKILLS_DIR = os.path.join(BASE_DIR, "skills")
AGENTS_DIR = os.path.join(BASE_DIR, "agents")
REGISTRY_DIR = os.path.join(BASE_DIR, "registry")
WORKFLOWS_DIR = os.path.join(BASE_DIR, "workflows")
DOCS_DIR = os.path.join(BASE_DIR, "docs")

REGISTRY_FILE = os.path.join(REGISTRY_DIR, "skills.json")
AGENTS_REGISTRY_FILE = os.path.join(REGISTRY_DIR, "agents.json")
WORKFLOW_HISTORY_FILE = os.path.join(REGISTRY_DIR, "workflow_history.json")
```

**Helper Functions**:
- `get_skill_path(skill_name)` - Directory path for skill
- `get_skill_manifest_path(skill_name)` - Path to skill.yaml
- `get_agent_path(agent_name)` - Directory path for agent
- `get_agent_manifest_path(agent_name)` - Path to agent.yaml
- `ensure_directories()` - Create required directories

### Validation System (`betty/validation.py`)

**Functions**:
- `validate_skill_name(name)` - Check naming convention
- `validate_agent_name(name)` - Check agent naming convention
- `validate_path(path, must_exist)` - File path validation
- `validate_manifest_fields(manifest, required_fields)` - Check required fields
- `validate_version(version)` - Semantic version validation
- `validate_reasoning_mode(mode)` - Agent reasoning mode validation
- `validate_skills_exist(skills, skill_registry)` - Verify skills in registry

### Error Handling (`betty/errors.py`)

**Exception Classes**:
```python
BettyError                    # Base exception
â”œâ”€â”€ SkillNotFoundError
â”œâ”€â”€ SkillValidationError
â”œâ”€â”€ RegistryError
â”œâ”€â”€ WorkflowError
â”œâ”€â”€ ManifestError
â”œâ”€â”€ AgentValidationError      # NEW - Phase 4
â”œâ”€â”€ AgentRegistryError        # NEW - Phase 4
â””â”€â”€ ...

format_error_response(error, include_traceback)  # Standardized error formatting
```

### Registries

**Skills Registry** (`/registry/skills.json`):
```json
{
  "registry_version": "1.0.0",
  "generated_at": "2025-10-23T01:40:13.390630+00:00",
  "skills": [
    {
      "name": "skill.define",
      "version": "0.1.0",
      "description": "...",
      "inputs": [...],
      "outputs": [...],
      "dependencies": [],
      "status": "active",
      "entrypoints": [...]
    }
  ]
}
```

**Agents Registry** (`/registry/agents.json`):
```json
{
  "registry_version": "1.0.0",
  "generated_at": "2025-10-23T01:39:51.136417+00:00",
  "agents": [
    {
      "name": "api.designer",
      "version": "0.1.0",
      "description": "...",
      "reasoning_mode": "iterative",
      "skills_available": [...],
      "capabilities": [...],
      "status": "draft",
      "tags": [...],
      "dependencies": []
    }
  ]
}
```

---

## What Exists vs What's Missing

### Fully Implemented (Green Light)

âœ… **Skill Infrastructure**
- Skill creation, validation, registration
- Skill manifest schema
- Skill registry with full CRUD operations
- Skill naming conventions and validation

âœ… **Workflow Infrastructure**
- Workflow composition and orchestration
- Workflow validation
- Workflow execution audit trail
- Multi-step process support

âœ… **Hook Infrastructure**
- Hook definition and registration
- Hook event handling (on_file_edit, on_commit, etc.)
- Hook configuration in `.claude/hooks.yaml`
- Integration with API validation

âœ… **Agent Infrastructure (Phase 4)**
- Agent validation and registration
- Agent registry with full CRUD operations
- Agent manifest schema
- Agent naming conventions and validation
- Agent reasoning modes (iterative/oneshot)
- Skill reference validation from agents

âœ… **API Development Skills**
- OpenAPI/AsyncAPI spec creation (api.define)
- Spec validation against Zalando guidelines (api.validate)
- Type-safe model generation (api.generate-models)
- Breaking change detection (api.compatibility)

âœ… **User Interface (Phase 3)**
- Slash commands documented in markdown
- Command structure defined
- Integration with agents/workflows planned

### Missing / Incomplete (Red Flags)

âŒ **command.define Skill** (CRITICAL)
- Referenced in api-driven-development.md (line 97-99)
- Not implemented in `/skills/`
- No command registration system
- Commands currently hardcoded in markdown files

**What Needs to Be Built**:
1. Skill manifest for `command.define` (skill.yaml)
2. Command validation logic (command naming, parameter validation)
3. Command manifest schema definition
4. Command registry or integration with Claude Code plugin system
5. Handler script to programmatically register commands
6. Documentation for command creation workflow

**Current Workaround**:
- Commands are manually documented in `.claude/commands/`
- No programmatic way to create/manage commands
- Commands reference agents/workflows but no registration system

âŒ **Command Registry**
- No `/registry/commands.json` exists
- No mechanism to query available commands
- No versioning for commands
- No audit trail for command usage

**What Needs to Be Built**:
1. Command registry file format
2. CRUD operations for commands
3. Command status tracking (active, deprecated, etc.)
4. Integration with command.define skill

âŒ **Command-to-Agent/Workflow Mapping**
- Commands documented but not linked to agents
- No formal execution model defined
- Parameter passing between command and agent not specified

**What Needs to Be Built**:
1. Formal command execution model
2. Parameter type definitions for commands
3. Response format specification
4. Error handling and validation

---

## Implementation Plans & References

### Documented Plans

**File**: `/home/user/betty/docs/agent-define-implementation-plan.md`
- Complete implementation plan for agent.define skill (COMPLETED)
- Includes configuration updates, validation strategy, checklist
- Provides testing strategy and error handling examples

**File**: `/home/user/betty/docs/betty-architecture.md`
- Comprehensive five-layer architecture specification
- Includes examples of each layer
- Integration flow documentation
- Design principles and separation of concerns

**File**: `/home/user/betty/docs/api-driven-development.md`
- Complete guide for API-first development workflow
- Zalando guidelines compliance documentation
- Modelina integration guide
- Workflow examples and usage patterns

### Missing Documentation

- âŒ Command infrastructure specification
- âŒ Command manifest schema
- âŒ Command.define skill implementation plan
- âŒ Command registry specification

---

## Code Quality & Standards

### Naming Conventions

**Skills**: `<domain>.<action>` 
- Examples: `api.define`, `workflow.validate`, `hook.define`, `agent.define`
- Regex: `^[a-z][a-z0-9._-]*$`

**Agents**: `<domain>.<action>`
- Examples: `api.designer`, `api.analyzer`, `compliance.checker`
- Regex: `^[a-z][a-z0-9._-]*$`

**Version Format**: Semantic versioning `MAJOR.MINOR.PATCH[-prerelease]`

**Status Values**: `draft`, `active`, `deprecated`, `archived`

### Error Handling Patterns

All skills follow consistent error response format:
```json
{
  "ok": false,
  "status": "failed",
  "errors": ["Error message 1", "Error message 2"],
  "path": "path/to/file",
  "details": { ... }
}
```

### Testing Infrastructure

**Current**:
- pytest.ini configured
- Test files in `/tests/` directory
- skill.create includes test scaffolding

**Missing**:
- No command.define tests
- Limited test documentation
- No integration test suite for full five-layer flow

---

## TODO Comments Found in Codebase

**File**: `/home/user/betty/skills/skill.create/skill_create.py`
```python
TODO: Add usage instructions
TODO: Document inputs
TODO: Document outputs
TODO: List dependencies
TODO: Add arguments (line 96)
TODO: Implement skill logic (line 104)
```

---

## Key Technology Stack

- **Language**: Python 3.11+
- **YAML**: PyYAML for manifest parsing
- **API Validation**: Zally (Zalando's linter)
- **Code Generation**: Modelina
- **OpenAPI**: 3.1 specification
- **AsyncAPI**: 3.0 specification
- **Git**: Hooks support via Claude Code
- **JSON**: Registry serialization

---

## Current Phase Status

### Phase 1: Foundation (Hooks + Skills) - COMPLETE âœ…
- Implemented basic skill infrastructure
- Implemented hook system
- Created api.validate and api.define skills
- Generated hooks for automatic validation

### Phase 2: Orchestration (Workflows) - COMPLETE âœ…
- Implemented workflow composition
- Implemented workflow validation
- Created api.generate-models and api.compatibility skills

### Phase 3: Interface (Commands) - COMPLETE âœ…
- Documented slash commands
- Created command markdown files
- Integration with agents planned

### Phase 4: Intelligence (Agents) - IN PROGRESS ğŸš€
- Implemented agent.define skill
- Created agent registry infrastructure
- Defined agent manifest schema
- Drafted api.designer and api.analyzer agents
- **Missing**: command.define skill to bridge to user interface

### Phase 5: Advanced Features - NOT STARTED
- Multi-agent collaboration
- Advanced reasoning patterns
- Marketplace integration
- Policy enforcement system

---

## Recommendations for Command Infrastructure

### Immediate Needs (Critical Path)

1. **Create command.define Skill**
   - Mirror structure of agent.define and skill.define
   - Validate command naming, parameters, and execution targets
   - Register commands in command registry

2. **Define Command Manifest Schema**
   - Name, description, parameters
   - Execution target (agent/workflow/skill)
   - Parameter type definitions and validation
   - Status and versioning

3. **Create Command Registry** (`/registry/commands.json`)
   - Track all registered commands
   - Version tracking
   - Status and deprecation tracking
   - Execution audit trail

4. **Implement Command Execution Model**
   - How commands receive parameters
   - How commands invoke agents/workflows
   - How responses are formatted
   - Error handling and validation

### Future Enhancements

- Command discovery API
- Command versioning and compatibility checking
- Command deprecation warnings
- Command usage analytics
- Dynamic command registration
- Command aliases and shortcuts
- Context-aware command suggestions

---

## Integration Points

**The five layers integrate as follows**:

```
User Input
    â†“
Commands (Layer 1)
    â†“ delegates to
Agents (Layer 2)
    â†“ orchestrates
Workflows (Layer 3)
    â†“ executes
Skills (Layer 4)
    â†“ protected by
Hooks (Layer 5)
    â†“ validates/blocks
User Output
```

**Current Status**:
- Layers 4-5 (Skills + Hooks): FULLY FUNCTIONAL
- Layer 3 (Workflows): FULLY FUNCTIONAL
- Layer 2 (Agents): MOSTLY DONE (waiting on commands)
- Layer 1 (Commands): DOCUMENTED but INCOMPLETE (missing command.define)

---

## Summary

The Betty Framework is a well-architected system that successfully implements:
- A five-layer architecture for AI-driven development
- Comprehensive skill infrastructure with validation and registry
- Automatic validation via hooks
- Workflow orchestration with audit trails
- Agent-based reasoning layer with skill composition

**The critical gap** is the **command infrastructure**, specifically:
- No `command.define` skill to programmatically register commands
- No command registry to track available commands
- No formal command execution model
- Commands exist only as documentation

This gap prevents the full integration of the five-layer architecture. Once `command.define` is implemented, users can run `/api-design service-name` which will delegate to agents, which orchestrate workflows, which execute skills, all protected by hooksâ€”completing the vision of structured, auditable AI-assisted engineering.

